#!/usr/bin/env python3
# scanner for CVE-2019-0708

import json
import subprocess

# zmap scan
# subprocess.run([
#     'sudo','zmap',
#     '--target-port=3389',
#     '--output-file=zmap_results111.csv',
#     # '--quiet',
#     '--bandwidth=10M',
#     '--max-runtime=100',
#     '--metadata-file=zmap_meta.json'
# ])

with open('zmap_meta.json','r') as f:
    meta = json.load(f)

hitrate = meta['success_total']/meta['total_sent']

filt_ips = ""
filt_cnt = 0

with open('zmap_results111.csv','r') as f:
    for ip in f:
        print('\rnmap {}:3389\t\r'.format(ip.rstrip()), end='', flush=True)
        subprocess.run([
            'sudo','nmap',
            '-oG','temp.txt',
            '-Pn','-sV','-v0',
            '-script=banner',
            '-p','3389',ip.rstrip()
        ])
        if subprocess.run([
            'grep','-q',
            '-e','Windows 7',
            '-e','Windows 8',
            '-e','Windows XP',
            '-e','Windows Server',
            'temp.txt'
        ]).returncode == 0:
            filt_ips += ip
            filt_cnt += 1

subprocess.run(['rm','temp.txt'])

with open('filtered.csv','w') as f:
    f.write(filt_ips)

filt_hr = filt_cnt/meta['total_sent']
print('\nzmap scan hitrate: {0:.3g}%'.format(hitrate*100))
print('nmap filt hitrate: {0:.3g}%'.format(filthr*100))

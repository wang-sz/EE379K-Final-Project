#!/usr/bin/env python3
# scanner for CVE-2014-2256

import json
import subprocess

# zmap scan
subprocess.run([
    'sudo','zmap',
    '--target-port=102',
    '--output-file=zmap_results.csv',
    # '--quiet',
    '--bandwidth=1000M',
    '--max-runtime=20000',
    '--metadata-file=zmap_meta.json'
])

with open('zmap_meta.json','r') as f:
    meta = json.load(f)

hitrate = meta['success_total']/meta['total_sent']

filt_ips = ""
filt_cnt = 0

with open('zmap_results.csv','r') as f:
    for ip in f:
        print('\rnmap {}:102\t\r'.format(ip.rstrip()), end='', flush=True)
        subprocess.run([
            'sudo','nmap',
            '-oG','temp.txt',
            '-Pn','-sV','-v0',
            '-script=banner',
            '-p','102',ip.rstrip()
        ])
        if subprocess.run(['grep','-q','Siemens','temp.txt']).returncode == 0:
            filt_ips += ip
            filt_cnt += 1

subprocess.run(['rm','temp.txt'])

with open('filtered.csv','w') as f:
    f.write(filt_ips)

filt_hr = filt_cnt/meta['total_sent']
print('\nzmap scan hitrate: {0:.3g}%'.format(hitrate*100))
print('nmap filt hitrate: {0:.3g}%'.format(filthr*100))
